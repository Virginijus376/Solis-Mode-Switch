name: Test SolisCloud Control

on:
  workflow_dispatch:

jobs:
  test-api:
    runs-on: ubuntu-latest
    env:
      APP_ID: ${{ secrets.SOLIS_APP_ID }}
      APP_SECRET: ${{ secrets.SOLIS_APP_SECRET }}
      DEVICE_SN: ${{ secrets.SOLIS_DEVICE_SN }}

    steps:
      - name: Gauti UTC laikƒÖ RFC formatu
        id: time
        run: echo "date=$(date -u '+%a, %d %b %Y %H:%M:%S GMT')" >> $GITHUB_OUTPUT

      - name: Gauti access_token
        id: token
        run: |
          BASIC_AUTH=$(echo -n "${APP_ID}:${APP_SECRET}" | base64)
          RESPONSE=$(curl -s -X POST https://www.soliscloud.com:13333/oauth2/token \
            -H "Authorization: Basic $BASIC_AUTH" \
            -H "Date: '${{ steps.time.outputs.date }}'" \
            -H "Content-Type: application/x-www-form-urlencoded")
          echo "üì• Response: $RESPONSE"
          TOKEN=$(echo "$RESPONSE" | jq -r '.data.access_token')
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Si≈≥sti inverteriui darbo re≈æimƒÖ
        run: |
          WORKMODE=2  # 1 = Self-Use, 2 = Selling First
          curl -s -X POST https://www.soliscloud.com:13333/api/v1/device/setting/control \
            -H "Authorization: Bearer ${{ steps.token.outputs.token }}" \
            -H "Content-Type: application/json" \
            -d "{\"deviceSn\": \"${DEVICE_SN}\", \"workMode\": $WORKMODE, \"source\": 1}"
