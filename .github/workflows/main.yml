name: SolisCloud re≈æimo keitimas

on:
  schedule:
    - cron: '0 0 * * *'    # 03:00 LT ‚Äì Selling First
    - cron: '0 12 * * *'   # 15:00 LT ‚Äì Self-Use
  workflow_dispatch:

jobs:
  switch-mode:
    runs-on: ubuntu-latest

    steps:
      - name: Paruo≈°ti re≈æimƒÖ ir timestamp‚Äôus
        run: |
          hour=$(date +%H)
          if (( 10#$hour < 12 )); then
            echo "MODE=2" >> $GITHUB_ENV
            echo "LABEL=Selling First" >> $GITHUB_ENV
          else
            echo "MODE=3" >> $GITHUB_ENV
            echo "LABEL=Self-Use" >> $GITHUB_ENV
          fi
          # ≈†itas blokas MƒñTINAMAS VISADA:
          echo "TODAY=$(date +%F)" >> $GITHUB_ENV
          echo "NOW=$(date +%T)" >> $GITHUB_ENV

      - name: Gauti prieigos tokenƒÖ
        env:
          APP_ID:     ${{ secrets.APP_ID }}
          APP_SECRET: ${{ secrets.APP_SECRET }}
        run: |
          TOKEN=$(curl -s -X POST https://www.soliscloud.com:13333/oauth2/token \
            -H "Content-Type: application/json" \
            -d "{\"appId\":\"$APP_ID\",\"secret\":\"$APP_SECRET\"}" \
            | jq -r '.access_token // .data.access_token')
          echo "TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Pritaikyti inverterio re≈æimƒÖ
        env:
          DEVICE_SN: ${{ secrets.DEVICE_SN }}
        run: |
          echo "‚ñ∂Ô∏è Re≈æimas:    $LABEL"
          echo "üìÖ Data:      $TODAY"
          echo "‚è∞ Laikas:    $NOW"

          response=$(curl -s -X POST https://www.soliscloud.com:13333/api/v1/device/setting/control \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"deviceSn\":\"$DEVICE_SN\",\"param\":{\"workMode\":$MODE,\"date\":\"$TODAY\",\"time\":\"$NOW\",\"source\":1}}")
          echo "‚û°Ô∏è API atsakymas: $response"
